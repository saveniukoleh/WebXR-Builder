"use strict";(self["webpackChunkwebxr_builder"]=self["webpackChunkwebxr_builder"]||[]).push([[197],{7791:function(e,t,n){n.r(t),n.d(t,{default:function(){return W}});var o=n(3396);const s={class:"three-demo-1"},i=(0,o._)("h1",null,"Three.js WebVR Hand Input",-1),r=(0,o._)("div",{id:"vr-renderer-wrapper-handinput"},null,-1),a=[i,r];function c(e,t,n,i,r,c){return(0,o.wg)(),(0,o.iD)("div",s,a)}var d=n(1114),h=n(1341),p=n(7061),l=(n(560),n(9469));const m="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class u{constructor(e,t,n,o,s=null){this.controller=t,this.handModel=e,this.bones=[],null===s&&(s=new l.E,s.setPath(n||m)),s.load(`${o}.glb`,(e=>{const t=e.scene.children[0];this.handModel.add(t);const n=t.getObjectByProperty("type","SkinnedMesh");n.frustumCulled=!1,n.castShadow=!0,n.receiveShadow=!0;const s=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"];s.forEach((e=>{const n=t.getObjectByName(e);void 0!==n?n.jointName=e:console.warn(`Couldn't find ${e} in ${o} hand mesh`),this.bones.push(n)}))}))}updateMesh(){const e=this.controller.joints;for(let t=0;t<this.bones.length;t++){const n=this.bones[t];if(n){const t=e[n.jointName];if(t.visible){const e=t.position;n.position.copy(e),n.quaternion.copy(t.quaternion)}}}}}const y=.01,_="index-finger-tip";class f extends d.Tme{constructor(e,t=null){super(),this.controller=e,this.motionController=null,this.envMap=null,this.loader=t,this.mesh=null,e.addEventListener("connected",(t=>{const n=t.data;n.hand&&!this.motionController&&(this.xrInputSource=n,this.motionController=new u(this,e,this.path,n.handedness,this.loader))})),e.addEventListener("disconnected",(()=>{this.clear(),this.motionController=null}))}updateMatrixWorld(e){super.updateMatrixWorld(e),this.motionController&&this.motionController.updateMesh()}getPointerPosition(){const e=this.controller.joints[_];return e?e.position:null}intersectBoxObject(e){const t=this.getPointerPosition();if(t){const n=new d.aLr(t,y),o=(new d.ZzF).setFromObject(e);return n.intersectsBox(o)}return!1}checkButton(e){this.intersectBoxObject(e)?e.onPress():e.onClear(),e.isPressed()&&e.whilePressed()}}const g=.05,v=.02,w=.01,C=.02,E=1,x=.4,b=.002,M=.01,T=.003,S=.035,O=16,P=12,R=110,N=new d.Pa4(0,1,0),I=new d.Pa4(0,0,1),D=.02,A=1.5;class q extends d.Tme{constructor(e,t){super(),this.hand=e,this.controller=t,this.motionController=null,this.envMap=null,this.mesh=null,this.pointerGeometry=null,this.pointerMesh=null,this.pointerObject=null,this.pinched=!1,this.attached=!1,this.cursorObject=null,this.raycaster=null,this._onConnected=this._onConnected.bind(this),this._onDisconnected=this._onDisconnected.bind(this),this.hand.addEventListener("connected",this._onConnected),this.hand.addEventListener("disconnected",this._onDisconnected)}_onConnected(e){const t=e.data;t.hand&&(this.visible=!0,this.xrInputSource=t,this.createPointer())}_onDisconnected(){this.visible=!1,this.xrInputSource=null,this.pointerGeometry&&this.pointerGeometry.dispose(),this.pointerMesh&&this.pointerMesh.material&&this.pointerMesh.material.dispose(),this.clear()}_drawVerticesRing(e,t,n){const o=t.clone();for(let s=0;s<O;s++){o.applyAxisAngle(I,2*Math.PI/O);const t=n*O+s;e[3*t]=o.x,e[3*t+1]=o.y,e[3*t+2]=o.z}}_updatePointerVertices(e){const t=this.pointerGeometry.attributes.position.array,n=new d.Pa4(b,0,-1*(S-e));this._drawVerticesRing(t,n,0);const o=new d.Pa4(Math.sin(Math.PI*R/180)*e,Math.cos(Math.PI*R/180)*e,0);for(let c=0;c<P;c++)this._drawVerticesRing(t,o,c+1),o.applyAxisAngle(N,Math.PI*R/180/(-2*P));const s=O*(1+P),i=O*(1+P)+1,r=new d.Pa4(0,0,-1*(S-e));t[3*s]=r.x,t[3*s+1]=r.y,t[3*s+2]=r.z;const a=new d.Pa4(0,0,e);t[3*i]=a.x,t[3*i+1]=a.y,t[3*i+2]=a.z,this.pointerGeometry.setAttribute("position",new d.a$l(t,3))}createPointer(){let e,t;const n=new Array(3*((P+1)*O+2)).fill(0),o=[];for(this.pointerGeometry=new d.u9r,this.pointerGeometry.setAttribute("position",new d.a$l(n,3)),this._updatePointerVertices(M),e=0;e<P;e++){for(t=0;t<O-1;t++)o.push(e*O+t,e*O+t+1,(e+1)*O+t),o.push(e*O+t+1,(e+1)*O+t+1,(e+1)*O+t);o.push((e+1)*O-1,e*O,(e+2)*O-1),o.push(e*O,(e+1)*O,(e+2)*O-1)}const s=O*(1+P),i=O*(1+P)+1;for(e=0;e<O-1;e++)o.push(s,e+1,e),o.push(i,e+O*P,e+O*P+1);o.push(s,0,O-1),o.push(i,O*(P+1)-1,O*P);const r=new d.vBJ;r.transparent=!0,r.opacity=x,this.pointerGeometry.setIndex(o),this.pointerMesh=new d.Kj0(this.pointerGeometry,r),this.pointerMesh.position.set(0,0,-1*M),this.pointerObject=new d.Tme,this.pointerObject.add(this.pointerMesh),this.raycaster=new d.iMs;const a=new d.xo$(D,10,10),c=new d.vBJ;c.transparent=!0,c.opacity=x,this.cursorObject=new d.Kj0(a,c),this.pointerObject.add(this.cursorObject),this.add(this.pointerObject)}_updateRaycaster(){if(this.raycaster){const e=this.pointerObject.matrixWorld,t=new d.yGw;t.identity().extractRotation(e),this.raycaster.ray.origin.setFromMatrixPosition(e),this.raycaster.ray.direction.set(0,0,-1).applyMatrix4(t)}}_updatePointer(){this.pointerObject.visible=this.controller.visible;const e=this.hand.joints["index-finger-tip"],t=this.hand.joints["thumb-tip"],n=e.position.distanceTo(t.position),o=e.position.clone().add(t.position).multiplyScalar(.5);this.pointerObject.position.copy(o),this.pointerObject.quaternion.copy(this.controller.quaternion),this.pinched=n<=v;const s=(n-w)/(g-w),i=(n-w)/(v-w);if(s>1)this._updatePointerVertices(M),this.pointerMesh.position.set(0,0,-1*M),this.pointerMesh.material.opacity=x;else if(s>0){const e=(M-T)*s+T;this._updatePointerVertices(e),i<1?(this.pointerMesh.position.set(0,0,-1*e-(1-i)*C),this.pointerMesh.material.opacity=x+(1-i)*(E-x)):(this.pointerMesh.position.set(0,0,-1*e),this.pointerMesh.material.opacity=x)}else this._updatePointerVertices(T),this.pointerMesh.position.set(0,0,-1*T-C),this.pointerMesh.material.opacity=E;this.cursorObject.material.opacity=this.pointerMesh.material.opacity}updateMatrixWorld(e){super.updateMatrixWorld(e),this.pointerGeometry&&(this._updatePointer(),this._updateRaycaster())}isPinched(){return this.pinched}setAttached(e){this.attached=e}isAttached(){return this.attached}intersectObject(e,t=!0){if(this.raycaster)return this.raycaster.intersectObject(e,t)}intersectObjects(e,t=!0){if(this.raycaster)return this.raycaster.intersectObjects(e,t)}checkIntersections(e,t=!1){if(this.raycaster&&!this.attached){const n=this.raycaster.intersectObjects(e,t),o=new d.Pa4(0,0,-1);if(n.length>0){const e=n[0],t=e.distance;this.cursorObject.position.copy(o.multiplyScalar(t))}else this.cursorObject.position.copy(o.multiplyScalar(A))}}setCursor(e){const t=new d.Pa4(0,0,-1);this.raycaster&&!this.attached&&this.cursorObject.position.copy(t.multiplyScalar(e))}dispose(){this._onDisconnected(),this.hand.removeEventListener("connected",this._onConnected),this.hand.removeEventListener("disconnected",this._onDisconnected)}}function j(e,t){const n=document.createElement("canvas"),o=n.getContext("2d");let s=null;const i=100;o.font="normal "+i+"px Arial",s=o.measureText(e);const r=s.width;n.width=r,n.height=i,o.font="normal "+i+"px Arial",o.textAlign="center",o.textBaseline="middle",o.fillStyle="#ffffff",o.fillText(e,r/2,i/2);const a=new d.xEZ(n);a.needsUpdate=!0;const c=new d.vBJ({color:16777215,side:d.ehD,map:a,transparent:!0}),h=new d._12(t*r/i,t),p=new d.Kj0(h,c);return p}var L=n(700),k={mounted(){class e extends L.wA{}e.schema={object:{type:L.Yk.Ref}};class t extends L.wA{}t.schema={currState:{type:L.Yk.String,default:"none"},prevState:{type:L.Yk.String,default:"none"},action:{type:L.Yk.Ref,default:()=>{}}};class n extends L.xP{execute(){this.queries.buttons.results.forEach((n=>{const o=n.getMutableComponent(t),s=n.getComponent(e).object;"none"==o.currState?s.scale.set(1,1,1):s.scale.set(1.1,1.1,1.1),"pressed"==o.currState&&"pressed"!=o.prevState&&o.action(),o.prevState=o.currState,o.currState="none"}))}}n.queries={buttons:{components:[t]}};class o extends L.wA{}o.schema={state:{type:L.Yk.String,default:"none"},originalParent:{type:L.Yk.Ref,default:null},attachedPointer:{type:L.Yk.Ref,default:null}};class s extends L.xP{execute(){this.queries.draggable.results.forEach((t=>{const n=t.getMutableComponent(o),s=t.getComponent(e).object;switch(null==n.originalParent&&(n.originalParent=s.parent),n.state){case"to-be-attached":n.attachedPointer.children[0].attach(s),n.state="attached";break;case"to-be-detached":n.originalParent.attach(s),n.state="detached";break;default:s.scale.set(1,1,1)}}))}}s.queries={draggable:{components:[o]}};class i extends L.ZG{}class r extends L.xP{init(e){this.handPointers=e.handPointers}execute(){this.handPointers.forEach((n=>{let s=null,i=null;if(this.queries.intersectable.results.forEach((t=>{const o=t.getComponent(e).object,r=n.intersectObject(o,!1);r&&r.length>0&&(null==s||r[0].distance<s)&&(s=r[0].distance,i=t)})),s){if(n.setCursor(s),i.hasComponent(t)){const e=i.getMutableComponent(t);n.isPinched()?e.currState="pressed":"pressed"!=e.currState&&(e.currState="hovered")}if(i.hasComponent(o)){const t=i.getMutableComponent(o),s=i.getComponent(e).object;s.scale.set(1.1,1.1,1.1),n.isPinched()?n.isAttached()||"attached"==t.state||(t.state="to-be-attached",t.attachedPointer=n,n.setAttached(!0)):n.isAttached()&&"attached"==t.state&&(console.log("hello"),t.state="to-be-detached",t.attachedPointer=null,n.setAttached(!1))}}else n.setCursor(1.5)}))}}r.queries={intersectable:{components:[i]}};class a extends L.ZG{}class c extends L.xP{init(e){this.controllers=e.controllers}execute(){let t=!1;this.controllers.forEach((e=>{e.visible&&(t=!0)})),this.queries.instructionTexts.results.forEach((n=>{const o=n.getComponent(e).object;o.visible=t}))}}c.queries={instructionTexts:{components:[a]}};class l extends L.wA{}l.schema={x:{type:L.Yk.Number,default:0},y:{type:L.Yk.Number,default:0},z:{type:L.Yk.Number,default:0}};class m extends L.ZG{}class u extends L.xP{init(e){this.camera=e.camera,this.renderer=e.renderer}execute(){this.queries.needCalibration.results.forEach((t=>{if(this.renderer.xr.getSession()){const n=t.getComponent(l),o=t.getComponent(e).object,s=this.renderer.xr.getCamera();o.position.x=s.position.x+n.x,o.position.y=s.position.y+n.y,o.position.z=s.position.z+n.z,t.removeComponent(m)}}))}}u.queries={needCalibration:{components:[m]}};class y extends L.ZG{}class _ extends L.xP{init(){this.needRandomizing=!0}execute(){this.needRandomizing&&this.queries.randomizable.results.forEach((t=>{const n=t.getComponent(e).object;n.material.color.setHex(16777215*Math.random()),n.position.x=2*Math.random()-1,n.position.y=2*Math.random(),n.position.z=2*Math.random()-1,n.rotation.x=2*Math.random()*Math.PI,n.rotation.y=2*Math.random()*Math.PI,n.rotation.z=2*Math.random()*Math.PI,n.scale.x=Math.random()+.5,n.scale.y=Math.random()+.5,n.scale.z=Math.random()+.5,this.needRandomizing=!1}))}}_.queries={randomizable:{components:[y]}};const g=new L.q3,v=new d.SUY;let w,C,E;function x(e,t,n,o){const s=new d.DvJ(e,t,n),i=new d.xoR({color:o}),r=new d.Kj0(s,i);return r}function b(){const v=document.getElementById("vr-renderer-wrapper-handinput"),b=document.createElement("div");v.appendChild(b),C=new d.xsS,C.background=new d.Ilk(4473924),w=new d.cPb(50,window.innerWidth/window.innerHeight,.1,10),w.position.set(0,1.2,.3),C.add(new d.vmT(13421772,10066329,3));const T=new d.Ox3(16777215,3);T.position.set(0,6,0),T.castShadow=!0,T.shadow.camera.top=2,T.shadow.camera.bottom=-2,T.shadow.camera.right=2,T.shadow.camera.left=-2,T.shadow.mapSize.set(4096,4096),C.add(T),E=new d.CP7({antialias:!0}),E.setPixelRatio(window.devicePixelRatio),E.setSize(window.innerWidth,window.innerHeight),E.shadowMap.enabled=!0,E.xr.enabled=!0,E.xr.cameraAutoUpdate=!1,b.appendChild(E.domElement);const S={requiredFeatures:["hand-tracking"]};document.body.appendChild(h.N.createButton(E,S));const O=E.xr.getController(0);C.add(O);const P=E.xr.getController(1);C.add(P);const R=new p.i,N=E.xr.getControllerGrip(0);N.add(R.createControllerModel(N)),C.add(N);const I=E.xr.getHand(0);I.add(new f(I));const D=new q(I,O);I.add(D),C.add(I);const A=E.xr.getControllerGrip(1);A.add(R.createControllerModel(A)),C.add(A);const L=E.xr.getHand(1);L.add(new f(L));const k=new q(L,P);L.add(k),C.add(L);const V=new d._12(4,4),B=new d.xoR({color:2236962}),W=new d.Kj0(V,B);W.rotation.x=-Math.PI/2,W.receiveShadow=!0,C.add(W);const z=new d._12(.24,.5),Y=new d.xoR({opacity:0,transparent:!0}),G=new d.Kj0(z,Y);G.position.set(.4,1,-1),G.rotation.y=-Math.PI/12,C.add(G);const Q=x(.2,.1,.01,3497085),$=j("reset",.06);Q.add($),$.position.set(0,0,.0051),Q.position.set(0,-.06,0),G.add(Q);const H=x(.2,.1,.01,16711680),J=j("exit",.06);H.add(J),J.position.set(0,0,.0051),H.position.set(0,-.18,0),G.add(H);const U=j("This is a WebXR Hands demo, please explore with hands.",.04);U.position.set(0,1.6,-.6),C.add(U);const K=j("Exiting session...",.04);K.position.set(0,1.5,-.6),K.visible=!1,C.add(K),g.registerComponent(e).registerComponent(t).registerComponent(i).registerComponent(a).registerComponent(l).registerComponent(m).registerComponent(y).registerComponent(o),g.registerSystem(_).registerSystem(c,{controllers:[N,A]}).registerSystem(u,{renderer:E,camera:w}).registerSystem(n).registerSystem(s).registerSystem(r,{handPointers:[D,k]});for(let t=0;t<20;t++){const t=new d.Kj0(new d.DvJ(.15,.15,.15),new d.YBo({color:16777215}));C.add(t);const n=g.createEntity();n.addComponent(i),n.addComponent(y),n.addComponent(e,{object:t}),n.addComponent(o)}const F=g.createEntity();F.addComponent(i),F.addComponent(l,{x:.4,y:0,z:-1}),F.addComponent(m),F.addComponent(e,{object:G});const Z=g.createEntity();Z.addComponent(i),Z.addComponent(e,{object:Q});const X=function(){g.getSystem(_).needRandomizing=!0};Z.addComponent(t,{action:X});const ee=g.createEntity();ee.addComponent(i),ee.addComponent(e,{object:H});const te=function(){K.visible=!0,setTimeout((function(){K.visible=!1,E?.xr?.getSession()?.end()}),2e3)};ee.addComponent(t,{action:te});const ne=g.createEntity();ne.addComponent(a),ne.addComponent(e,{object:U}),window.addEventListener("resize",M)}function M(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),E.setSize(window.innerWidth,window.innerHeight)}function T(){E.setAnimationLoop(S)}function S(){const e=v.getDelta(),t=v.elapsedTime;E.xr.updateCamera(w),g.execute(e,t),E.render(C,w)}b(),T();const O=()=>{E.setAnimationLoop(null),window.removeEventListener("resize",M),window.removeEventListener("component-unm÷ounted",O);const e=document.getElementById("VRButton");e&&document.body.removeChild(e)};window.addEventListener("component-unmounted",O)},unmounted(){window.dispatchEvent(new Event("component-unmounted"))}},V=n(89);const B=(0,V.Z)(k,[["render",c]]);var W=B},700:function(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__){__webpack_require__.d(__webpack_exports__,{Yk:function(){return Types},ZG:function(){return TagComponent},q3:function(){return World},wA:function(){return Component},xP:function(){return System}});var core_js_modules_es_array_push_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(560),core_js_modules_web_url_search_params_delete_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(8858),core_js_modules_web_url_search_params_has_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(1318),core_js_modules_web_url_search_params_size_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(3228);function queryKey(e){for(var t=[],n=0;n<e.length;n++){var o=e[n];if(!componentRegistered(o))throw new Error("Tried to create a query with an unregistered component");if("object"===typeof o){var s="not"===o.operator?"!":o.operator;t.push(s+o.Component._typeId)}else t.push(o._typeId)}return t.sort().join("-")}const hasWindow="undefined"!==typeof window,now=hasWindow&&"undefined"!==typeof window.performance?performance.now.bind(performance):Date.now.bind(Date);function componentRegistered(e){return"object"===typeof e&&void 0!==e.Component._typeId||e.isComponent&&void 0!==e._typeId}class SystemManager{constructor(e){this._systems=[],this._executeSystems=[],this.world=e,this.lastExecutedSystem=null}registerSystem(e,t){if(!e.isSystem)throw new Error(`System '${e.name}' does not extend 'System' class`);if(void 0!==this.getSystem(e))return console.warn(`System '${e.getName()}' already registered.`),this;var n=new e(this.world,t);return n.init&&n.init(t),n.order=this._systems.length,this._systems.push(n),n.execute&&(this._executeSystems.push(n),this.sortSystems()),this}unregisterSystem(e){let t=this.getSystem(e);return void 0===t?(console.warn(`Can unregister system '${e.getName()}'. It doesn't exist.`),this):(this._systems.splice(this._systems.indexOf(t),1),t.execute&&this._executeSystems.splice(this._executeSystems.indexOf(t),1),this)}sortSystems(){this._executeSystems.sort(((e,t)=>e.priority-t.priority||e.order-t.order))}getSystem(e){return this._systems.find((t=>t instanceof e))}getSystems(){return this._systems}removeSystem(e){var t=this._systems.indexOf(e);~t&&this._systems.splice(t,1)}executeSystem(e,t,n){if(e.initialized&&e.canExecute()){let o=now();e.execute(t,n),e.executeTime=now()-o,this.lastExecutedSystem=e,e.clearEvents()}}stop(){this._executeSystems.forEach((e=>e.stop()))}execute(e,t,n){this._executeSystems.forEach((o=>(n||o.enabled)&&this.executeSystem(o,e,t)))}stats(){for(var e={numSystems:this._systems.length,systems:{}},t=0;t<this._systems.length;t++){var n=this._systems[t],o=e.systems[n.getName()]={queries:{},executeTime:n.executeTime};for(var s in n.ctx)o.queries[s]=n.ctx[s].stats()}return e}}class ObjectPool{constructor(e,t){this.freeList=[],this.count=0,this.T=e,this.isObjectPool=!0,"undefined"!==typeof t&&this.expand(t)}acquire(){this.freeList.length<=0&&this.expand(Math.round(.2*this.count)+1);var e=this.freeList.pop();return e}release(e){e.reset(),this.freeList.push(e)}expand(e){for(var t=0;t<e;t++){var n=new this.T;n._pool=this,this.freeList.push(n)}this.count+=e}totalSize(){return this.count}totalFree(){return this.freeList.length}totalUsed(){return this.count-this.freeList.length}}class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var n=this._listeners[e];if(void 0!==n){var o=n.indexOf(t);-1!==o&&n.splice(o,1)}}dispatchEvent(e,t,n){this.stats.fired++;var o=this._listeners[e];if(void 0!==o)for(var s=o.slice(0),i=0;i<s.length;i++)s[i].call(this,t,n)}resetCounters(){this.stats.fired=this.stats.handled=0}}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach((e=>{"object"===typeof e?this.NotComponents.push(e.Component):this.Components.push(e)})),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=queryKey(e);for(var n=0;n<t._entities.length;n++){var o=t._entities[n];this.match(o)&&(o.queries.push(this),this.entities.push(o))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map((e=>e.name)),not:this.NotComponents.map((e=>e.name))},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";class QueryManager{constructor(e){this._world=e,this._queries={}}onEntityRemoved(e){for(var t in this._queries){var n=this._queries[t];-1!==e.queries.indexOf(n)&&n.removeEntity(e)}}onEntityComponentAdded(e,t){for(var n in this._queries){var o=this._queries[n];~o.NotComponents.indexOf(t)&&~o.entities.indexOf(e)?o.removeEntity(e):~o.Components.indexOf(t)&&o.match(e)&&!~o.entities.indexOf(e)&&o.addEntity(e)}}onEntityComponentRemoved(e,t){for(var n in this._queries){var o=this._queries[n];~o.NotComponents.indexOf(t)&&!~o.entities.indexOf(e)&&o.match(e)?o.addEntity(e):~o.Components.indexOf(t)&&~o.entities.indexOf(e)&&!o.match(e)&&o.removeEntity(e)}}getQuery(e){var t=queryKey(e),n=this._queries[t];return n||(this._queries[t]=n=new Query(e,this._world)),n}stats(){var e={};for(var t in this._queries)e[t]=this._queries[t].stats();return e}}class Component{constructor(e){if(!1!==e){const t=this.constructor.schema;for(const n in t)if(e&&e.hasOwnProperty(n))this[n]=e[n];else{const e=t[n];if(e.hasOwnProperty("default"))this[n]=e.type.clone(e.default);else{const t=e.type;this[n]=t.clone(t.default)}}void 0!==e&&this.checkUndefinedAttributes(e)}this._pool=null}copy(e){const t=this.constructor.schema;for(const n in t){const o=t[n];e.hasOwnProperty(n)&&(this[n]=o.type.copy(e[n],this[n]))}return this.checkUndefinedAttributes(e),this}clone(){return(new this.constructor).copy(this)}reset(){const e=this.constructor.schema;for(const t in e){const n=e[t];if(n.hasOwnProperty("default"))this[t]=n.type.copy(n.default,this[t]);else{const e=n.type;this[t]=e.copy(e.default,this[t])}}}dispose(){this._pool&&this._pool.release(this)}getName(){return this.constructor.getName()}checkUndefinedAttributes(e){const t=this.constructor.schema;Object.keys(e).forEach((e=>{t.hasOwnProperty(e)||console.warn(`Trying to set attribute '${e}' not defined in the '${this.constructor.name}' schema. Please fix the schema, the attribute value won't be set`)}))}}Component.schema={},Component.isComponent=!0,Component.getName=function(){return this.displayName||this.name};class SystemStateComponent extends Component{}SystemStateComponent.isSystemStateComponent=!0;class EntityPool extends ObjectPool{constructor(e,t,n){super(t,void 0),this.entityManager=e,"undefined"!==typeof n&&this.expand(n)}expand(e){for(var t=0;t<e;t++){var n=new this.T(this.entityManager);n._pool=this,this.freeList.push(n)}this.count+=e}}class EntityManager{constructor(e){this.world=e,this.componentsManager=e.componentsManager,this._entities=[],this._nextEntityId=0,this._entitiesByNames={},this._queryManager=new QueryManager(this),this.eventDispatcher=new EventDispatcher,this._entityPool=new EntityPool(this,this.world.options.entityClass,this.world.options.entityPoolSize),this.entitiesWithComponentsToRemove=[],this.entitiesToRemove=[],this.deferredRemovalEnabled=!0}getEntityByName(e){return this._entitiesByNames[e]}createEntity(e){var t=this._entityPool.acquire();return t.alive=!0,t.name=e||"",e&&(this._entitiesByNames[e]?console.warn(`Entity name '${e}' already exist`):this._entitiesByNames[e]=t),this._entities.push(t),this.eventDispatcher.dispatchEvent(ENTITY_CREATED,t),t}entityAddComponent(e,t,n){if("undefined"===typeof t._typeId&&!this.world.componentsManager._ComponentsMap[t._typeId])throw new Error(`Attempted to add unregistered component "${t.getName()}"`);if(~e._ComponentTypes.indexOf(t))console.warn("Component type already exists on entity.",e,t.getName());else{e._ComponentTypes.push(t),t.__proto__===SystemStateComponent&&e.numStateComponents++;var o=this.world.componentsManager.getComponentsPool(t),s=o?o.acquire():new t(n);o&&n&&s.copy(n),e._components[t._typeId]=s,this._queryManager.onEntityComponentAdded(e,t),this.world.componentsManager.componentAddedToEntity(t),this.eventDispatcher.dispatchEvent(COMPONENT_ADDED,e,t)}}entityRemoveComponent(e,t,n){var o=e._ComponentTypes.indexOf(t);~o&&(this.eventDispatcher.dispatchEvent(COMPONENT_REMOVE,e,t),n?this._entityRemoveComponentSync(e,t,o):(0===e._ComponentTypesToRemove.length&&this.entitiesWithComponentsToRemove.push(e),e._ComponentTypes.splice(o,1),e._ComponentTypesToRemove.push(t),e._componentsToRemove[t._typeId]=e._components[t._typeId],delete e._components[t._typeId]),this._queryManager.onEntityComponentRemoved(e,t),t.__proto__===SystemStateComponent&&(e.numStateComponents--,0!==e.numStateComponents||e.alive||e.remove()))}_entityRemoveComponentSync(e,t,n){e._ComponentTypes.splice(n,1);var o=e._components[t._typeId];delete e._components[t._typeId],o.dispose(),this.world.componentsManager.componentRemovedFromEntity(t)}entityRemoveAllComponents(e,t){let n=e._ComponentTypes;for(let o=n.length-1;o>=0;o--)n[o].__proto__!==SystemStateComponent&&this.entityRemoveComponent(e,n[o],t)}removeEntity(e,t){var n=this._entities.indexOf(e);if(!~n)throw new Error("Tried to remove entity not in list");e.alive=!1,this.entityRemoveAllComponents(e,t),0===e.numStateComponents&&(this.eventDispatcher.dispatchEvent(ENTITY_REMOVED,e),this._queryManager.onEntityRemoved(e),!0===t?this._releaseEntity(e,n):this.entitiesToRemove.push(e))}_releaseEntity(e,t){this._entities.splice(t,1),this._entitiesByNames[e.name]&&delete this._entitiesByNames[e.name],e._pool.release(e)}removeAllEntities(){for(var e=this._entities.length-1;e>=0;e--)this.removeEntity(this._entities[e])}processDeferredRemoval(){if(this.deferredRemovalEnabled){for(let e=0;e<this.entitiesToRemove.length;e++){let t=this.entitiesToRemove[e],n=this._entities.indexOf(t);this._releaseEntity(t,n)}this.entitiesToRemove.length=0;for(let t=0;t<this.entitiesWithComponentsToRemove.length;t++){let n=this.entitiesWithComponentsToRemove[t];while(n._ComponentTypesToRemove.length>0){let t=n._ComponentTypesToRemove.pop();var e=n._componentsToRemove[t._typeId];delete n._componentsToRemove[t._typeId],e.dispose(),this.world.componentsManager.componentRemovedFromEntity(t)}}this.entitiesWithComponentsToRemove.length=0}}queryComponents(e){return this._queryManager.getQuery(e)}count(){return this._entities.length}stats(){var e={numEntities:this._entities.length,numQueries:Object.keys(this._queryManager._queries).length,queries:this._queryManager.stats(),numComponentPool:Object.keys(this.componentsManager._componentPool).length,componentPool:{},eventDispatcher:this.eventDispatcher.stats};for(var t in this.componentsManager._componentPool){var n=this.componentsManager._componentPool[t];e.componentPool[n.T.getName()]={used:n.totalUsed(),size:n.count}}return e}}const ENTITY_CREATED="EntityManager#ENTITY_CREATE",ENTITY_REMOVED="EntityManager#ENTITY_REMOVED",COMPONENT_ADDED="EntityManager#COMPONENT_ADDED",COMPONENT_REMOVE="EntityManager#COMPONENT_REMOVE";class ComponentManager{constructor(){this.Components=[],this._ComponentsMap={},this._componentPool={},this.numComponents={},this.nextComponentId=0}hasComponent(e){return-1!==this.Components.indexOf(e)}registerComponent(e,t){if(-1!==this.Components.indexOf(e))return void console.warn(`Component type: '${e.getName()}' already registered.`);const n=e.schema;if(!n)throw new Error(`Component "${e.getName()}" has no schema property.`);for(const o in n){const t=n[o];if(!t.type)throw new Error(`Invalid schema for component "${e.getName()}". Missing type for "${o}" property.`)}e._typeId=this.nextComponentId++,this.Components.push(e),this._ComponentsMap[e._typeId]=e,this.numComponents[e._typeId]=0,void 0===t?t=new ObjectPool(e):!1===t&&(t=void 0),this._componentPool[e._typeId]=t}componentAddedToEntity(e){this.numComponents[e._typeId]++}componentRemovedFromEntity(e){this.numComponents[e._typeId]--}getComponentsPool(e){return this._componentPool[e._typeId]}}const Version="0.3.1",proxyMap=new WeakMap,proxyHandler={set(e,t){throw new Error(`Tried to write to "${e.constructor.getName()}#${String(t)}" on immutable component. Use .getMutableComponent() to modify a component.`)}};function wrapImmutableComponent(e,t){if(void 0===t)return;let n=proxyMap.get(t);return n||(n=new Proxy(t,proxyHandler),proxyMap.set(t,n)),n}class Entity{constructor(e){this._entityManager=e||null,this.id=e._nextEntityId++,this._ComponentTypes=[],this._components={},this._componentsToRemove={},this.queries=[],this._ComponentTypesToRemove=[],this.alive=!1,this.numStateComponents=0}getComponent(e,t){var n=this._components[e._typeId];return n||!0!==t||(n=this._componentsToRemove[e._typeId]),wrapImmutableComponent(e,n)}getRemovedComponent(e){const t=this._componentsToRemove[e._typeId];return wrapImmutableComponent(e,t)}getComponents(){return this._components}getComponentsToRemove(){return this._componentsToRemove}getComponentTypes(){return this._ComponentTypes}getMutableComponent(e){var t=this._components[e._typeId];if(t){for(var n=0;n<this.queries.length;n++){var o=this.queries[n];o.reactive&&-1!==o.Components.indexOf(e)&&o.eventDispatcher.dispatchEvent(Query.prototype.COMPONENT_CHANGED,this,t)}return t}}addComponent(e,t){return this._entityManager.entityAddComponent(this,e,t),this}removeComponent(e,t){return this._entityManager.entityRemoveComponent(this,e,t),this}hasComponent(e,t){return!!~this._ComponentTypes.indexOf(e)||!0===t&&this.hasRemovedComponent(e)}hasRemovedComponent(e){return!!~this._ComponentTypesToRemove.indexOf(e)}hasAllComponents(e){for(var t=0;t<e.length;t++)if(!this.hasComponent(e[t]))return!1;return!0}hasAnyComponents(e){for(var t=0;t<e.length;t++)if(this.hasComponent(e[t]))return!0;return!1}removeAllComponents(e){return this._entityManager.entityRemoveAllComponents(this,e)}copy(e){for(var t in e._components){var n=e._components[t];this.addComponent(n.constructor);var o=this.getComponent(n.constructor);o.copy(n)}return this}clone(){return new Entity(this._entityManager).copy(this)}reset(){for(var e in this.id=this._entityManager._nextEntityId++,this._ComponentTypes.length=0,this.queries.length=0,this._components)delete this._components[e]}remove(e){return this._entityManager.removeEntity(this,e)}}const DEFAULT_OPTIONS={entityPoolSize:0,entityClass:Entity};class World{constructor(e={}){if(this.options=Object.assign({},DEFAULT_OPTIONS,e),this.componentsManager=new ComponentManager(this),this.entityManager=new EntityManager(this),this.systemManager=new SystemManager(this),this.enabled=!0,this.eventQueues={},hasWindow&&"undefined"!==typeof CustomEvent){var t=new CustomEvent("ecsy-world-created",{detail:{world:this,version:Version}});window.dispatchEvent(t)}this.lastTime=now()/1e3}registerComponent(e,t){return this.componentsManager.registerComponent(e,t),this}registerSystem(e,t){return this.systemManager.registerSystem(e,t),this}hasRegisteredComponent(e){return this.componentsManager.hasComponent(e)}unregisterSystem(e){return this.systemManager.unregisterSystem(e),this}getSystem(e){return this.systemManager.getSystem(e)}getSystems(){return this.systemManager.getSystems()}execute(e,t){e||(t=now()/1e3,e=t-this.lastTime,this.lastTime=t),this.enabled&&(this.systemManager.execute(e,t),this.entityManager.processDeferredRemoval())}stop(){this.enabled=!1}play(){this.enabled=!0}createEntity(e){return this.entityManager.createEntity(e)}stats(){var e={entities:this.entityManager.stats(),system:this.systemManager.stats()};return e}}class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let t=0;t<this._mandatoryQueries.length;t++){var e=this._mandatoryQueries[t];if(0===e.entities.length)return!1}return!0}getName(){return this.constructor.getName()}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var n in this.constructor.queries){var o=this.constructor.queries[n],s=o.components;if(!s||0===s.length)throw new Error("'components' attribute can't be empty in a query");let e=s.filter((e=>!componentRegistered(e)));if(e.length>0)throw new Error(`Tried to create a query '${this.constructor.name}.${n}' with unregistered components: [${e.map((e=>e.getName())).join(", ")}]`);var i=this.world.entityManager.queryComponents(s);this._queries[n]=i,!0===o.mandatory&&this._mandatoryQueries.push(i),this.queries[n]={results:i.entities};var r=["added","removed","changed"];const t={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};o.listen&&r.forEach((e=>{if(this.execute||console.warn(`System '${this.getName()}' has defined listen events (${r.join(", ")}) for query '${n}' but it does not implement the 'execute' method.`),o.listen[e]){let s=o.listen[e];if("changed"===e){if(i.reactive=!0,!0===s){let t=this.queries[n][e]=[];i.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(e=>{-1===t.indexOf(e)&&t.push(e)}))}else if(Array.isArray(s)){let t=this.queries[n][e]=[];i.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,((e,n)=>{-1!==s.indexOf(n.constructor)&&-1===t.indexOf(e)&&t.push(e)}))}}else{let o=this.queries[n][e]=[];i.eventDispatcher.addEventListener(t[e],(e=>{-1===o.indexOf(e)&&o.push(e)}))}}}))}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.getName(),enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let n in t){let o=this.queries[n],s=t[n],i=e.queries[n]={key:this._queries[n].key};if(i.mandatory=!0===s.mandatory,i.reactive=s.listen&&(!0===s.listen.added||!0===s.listen.removed||!0===s.listen.changed||Array.isArray(s.listen.changed)),i.reactive){i.listen={};const e=["added","removed","changed"];e.forEach((e=>{o[e]&&(i.listen[e]={entities:o[e].length})}))}}}return e}}function Not(e){return{operator:"not",Component:e}}System.isSystem=!0,System.getName=function(){return this.displayName||this.name};class TagComponent extends Component{constructor(){super(!1)}}TagComponent.isTagComponent=!0;const copyValue=e=>e,cloneValue=e=>e,copyArray=(e,t)=>{if(!e)return e;if(!t)return e.slice();t.length=0;for(let n=0;n<e.length;n++)t.push(e[n]);return t},cloneArray=e=>e&&e.slice(),copyJSON=e=>JSON.parse(JSON.stringify(e)),cloneJSON=e=>JSON.parse(JSON.stringify(e)),copyCopyable=(e,t)=>e?t?t.copy(e):e.clone():e,cloneClonable=e=>e&&e.clone();function createType(e){var t=["name","default","copy","clone"],n=t.filter((t=>!e.hasOwnProperty(t)));if(n.length>0)throw new Error(`createType expects a type definition with the following properties: ${n.join(", ")}`);return e.isType=!0,e}const Types={Number:createType({name:"Number",default:0,copy:copyValue,clone:cloneValue}),Boolean:createType({name:"Boolean",default:!1,copy:copyValue,clone:cloneValue}),String:createType({name:"String",default:"",copy:copyValue,clone:cloneValue}),Array:createType({name:"Array",default:[],copy:copyArray,clone:cloneArray}),Ref:createType({name:"Ref",default:void 0,copy:copyValue,clone:cloneValue}),JSON:createType({name:"JSON",default:null,copy:copyJSON,clone:cloneJSON})};function generateId(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",o=n.length,s=0;s<e;s++)t+=n.charAt(Math.floor(Math.random()*o));return t}function injectScript(e,t){var n=document.createElement("script");n.src=e,n.onload=t,(document.head||document.documentElement).appendChild(n)}function hookConsoleAndErrors(e){var t=["error","warning","log"];t.forEach((t=>{if("function"===typeof console[t]){var n=console[t].bind(console);console[t]=(...o)=>(e.send({method:"console",type:t,args:JSON.stringify(o)}),n.apply(null,o))}})),window.addEventListener("error",(t=>{e.send({method:"error",error:JSON.stringify({message:t.error.message,stack:t.error.stack})})}))}function includeRemoteIdHTML(e){let t=document.createElement("div");return t.style.cssText="\n    align-items: center;\n    background-color: #333;\n    color: #aaa;\n    display:flex;\n    font-family: Arial;\n    font-size: 1.1em;\n    height: 40px;\n    justify-content: center;\n    left: 0;\n    opacity: 0.9;\n    position: absolute;\n    right: 0;\n    text-align: center;\n    top: 0;\n  ",t.innerHTML=`Open ECSY devtools to connect to this page using the code:&nbsp;<b style="color: #fff">${e}</b>&nbsp;<button onClick="generateNewCode()">Generate new code</button>`,document.body.appendChild(t),t}function enableRemoteDevtools(remoteId){if(!hasWindow)return void console.warn("Remote devtools not available outside the browser");window.generateNewCode=()=>{window.localStorage.clear(),remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId),window.location.reload(!1)},remoteId=remoteId||window.localStorage.getItem("ecsyRemoteId"),remoteId||(remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId));let infoDiv=includeRemoteIdHTML(remoteId);window.__ECSY_REMOTE_DEVTOOLS_INJECTED=!0,window.__ECSY_REMOTE_DEVTOOLS={};let Version="",worldsBeforeLoading=[],onWorldCreated=e=>{var t=e.detail.world;Version=e.detail.version,worldsBeforeLoading.push(t)};window.addEventListener("ecsy-world-created",onWorldCreated);let onLoaded=()=>{var peer=new Peer(remoteId,{host:"peerjs.ecsy.io",secure:!0,port:443,config:{iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},debug:3});peer.on("open",(()=>{peer.on("connection",(connection=>{window.__ECSY_REMOTE_DEVTOOLS.connection=connection,connection.on("open",(function(){infoDiv.innerHTML="Connected",connection.on("data",(function(data){if("init"===data.type){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.onload=()=>{script.parentNode.removeChild(script),window.removeEventListener("ecsy-world-created",onWorldCreated),worldsBeforeLoading.forEach((e=>{var t=new CustomEvent("ecsy-world-created",{detail:{world:e,version:Version}});window.dispatchEvent(t)}))},script.innerHTML=data.script,(document.head||document.documentElement).appendChild(script),script.onload(),hookConsoleAndErrors(connection)}else if("executeScript"===data.type){let value=eval(data.script);data.returnEval&&connection.send({method:"evalReturn",value:value})}}))}))}))}))};injectScript("https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js",onLoaded)}if(hasWindow){const e=new URLSearchParams(window.location.search);e.has("enable-remote-devtools")&&enableRemoteDevtools()}},1341:function(e,t,n){n.d(t,{N:function(){return o}});class o{static createButton(e){const t=document.createElement("button");function n(){let n=null;async function o(o){o.addEventListener("end",s),await e.xr.setSession(o),t.textContent="EXIT VR",n=o}function s(){n.removeEventListener("end",s),t.textContent="ENTER VR",n=null}t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="ENTER VR",t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){if(null===n){const e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]};navigator.xr.requestSession("immersive-vr",e).then(o)}else n.end()}}function s(){t.style.display="",t.style.cursor="auto",t.style.left="calc(50% - 75px)",t.style.width="150px",t.onmouseenter=null,t.onmouseleave=null,t.onclick=null}function i(){s(),t.textContent="VR NOT SUPPORTED"}function r(e){s(),console.warn("Exception when trying to call xr.isSessionSupported",e),t.textContent="VR NOT ALLOWED"}function a(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return t.id="VRButton",t.style.display="none",a(t),navigator.xr.isSessionSupported("immersive-vr").then((function(e){e?n():i(),e&&o.xrSessionIsGranted&&t.click()})).catch(r),t;{const e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",a(e),e}}static registerSessionGrantedListener(){if("undefined"!==typeof navigator&&"xr"in navigator){if(/WebXRViewer\//i.test(navigator.userAgent))return;navigator.xr.addEventListener("sessiongranted",(()=>{o.xrSessionIsGranted=!0}))}}}o.xrSessionIsGranted=!1,o.registerSessionGrantedListener()}}]);
//# sourceMappingURL=three-webvr-examples-handinput.ac5322aa.js.map